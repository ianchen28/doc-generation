# AIæ–‡æ¡£ç”Ÿæˆå™¨API - æ–°file_tokenåŠŸèƒ½curlå‘½ä»¤é›†åˆ
# ä½¿ç”¨æ–¹æ³•: å¤åˆ¶ç²˜è´´å‘½ä»¤åˆ°ç»ˆç«¯æ‰§è¡Œ

# =================================================================
# ç¯å¢ƒå˜é‡
# =================================================================
BASE_URL="http://localhost:8000/api/v1"

# =================================================================
# 1. å¥åº·æ£€æŸ¥
# =================================================================
echo "1. å¥åº·æ£€æŸ¥"
curl -X GET "$BASE_URL/health" \
  -H "Content-Type: application/json" \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

# =================================================================
# 2. å¤§çº²ç”Ÿæˆç«¯ç‚¹æµ‹è¯• (æ–°åŠŸèƒ½ï¼šè¿”å›file_token)
# =================================================================
echo "2. å¤§çº²ç”Ÿæˆç«¯ç‚¹æµ‹è¯•"
OUTLINE_RESPONSE=$(curl -s -X POST "$BASE_URL/jobs/outline" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test_session_001",
    "taskPrompt": "è¯·ç”Ÿæˆä¸€ä»½å…³äºäººå·¥æ™ºèƒ½æŠ€æœ¯å‘å±•è¶‹åŠ¿çš„è¯¦ç»†å¤§çº²",
    "isOnline": true,
    "contextFiles": [],
    "styleGuideContent": "è¯·ä½¿ç”¨ä¸“ä¸šçš„æŠ€æœ¯æ–‡æ¡£é£æ ¼",
    "requirements": "éœ€è¦åŒ…å«å®é™…æ¡ˆä¾‹å’Œæœªæ¥å‘å±•è¶‹åŠ¿"
  }')

echo "$OUTLINE_RESPONSE"
echo -e "\n"

# æå–taskId
TASK_ID=$(echo "$OUTLINE_RESPONSE" | grep -o '"redisStreamKey":"[^"]*"' | cut -d'"' -f4)
echo "TaskId: $TASK_ID"
echo -e "\n"

# =================================================================
# 3. ç­‰å¾…å¤§çº²ç”Ÿæˆå®Œæˆ
# =================================================================
echo "3. ç­‰å¾…å¤§çº²ç”Ÿæˆå®Œæˆ..."
echo "â³ ç­‰å¾…5ç§’..."
sleep 5

echo "ğŸ’¡ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç›‘å¬Redisæµè·å–file_token:"
echo "redis-cli XREAD COUNT 10 STREAMS $TASK_ID 0"
echo -e "\n"

# =================================================================
# 4. æ–‡æ¡£ç”Ÿæˆç«¯ç‚¹æµ‹è¯• (ä½¿ç”¨file_token)
# =================================================================
echo "4. æ–‡æ¡£ç”Ÿæˆç«¯ç‚¹æµ‹è¯• (ä½¿ç”¨file_token)"
curl -X POST "$BASE_URL/jobs/document-from-outline" \
  -H "Content-Type: application/json" \
  -d '{
    "taskPrompt": "åŸºäºå¤§çº²ç”Ÿæˆä¸€ä»½è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£",
    "sessionId": "test_session_001",
    "outline": "8b7e75b4150cde04bffba318da25068e",
    "contextFiles": [],
    "isOnline": true
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

# =================================================================
# 5. å¸¦context_filesçš„æ–‡æ¡£ç”Ÿæˆæµ‹è¯•
# =================================================================
echo "5. å¸¦context_filesçš„æ–‡æ¡£ç”Ÿæˆæµ‹è¯•"
curl -X POST "$BASE_URL/jobs/document-from-outline" \
  -H "Content-Type: application/json" \
  -d '{
    "taskPrompt": "åŸºäºå¤§çº²å’Œæä¾›çš„å‚è€ƒèµ„æ–™ç”ŸæˆæŠ€æœ¯æ–‡æ¡£",
    "sessionId": "test_session_002",
    "outline": "8b7e75b4150cde04bffba318da25068e",
    "contextFiles": [
      {
        "attachmentFileToken": "example_file_token_001",
        "attachmentType": 1
      },
      {
        "attachmentFileToken": "example_file_token_002",
        "attachmentType": 2
      }
    ],
    "isOnline": false
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

# =================================================================
# 6. æ¨¡æ‹Ÿæ–‡æ¡£ç”Ÿæˆç«¯ç‚¹æµ‹è¯•
# =================================================================
echo "6. æ¨¡æ‹Ÿæ–‡æ¡£ç”Ÿæˆç«¯ç‚¹æµ‹è¯•"
MOCK_RESPONSE=$(curl -s -X POST "$BASE_URL/jobs/document-from-outline-mock" \
  -H "Content-Type: application/json" \
  -d '{
    "taskPrompt": "æ¨¡æ‹Ÿç”ŸæˆæŠ€æœ¯æ–‡æ¡£",
    "sessionId": "mock_session_001",
    "outline": "8b7e75b4150cde04bffba318da25068e",
    "contextFiles": [],
    "isOnline": false
  }')

echo "$MOCK_RESPONSE"
echo -e "\n"

# æå–æ¨¡æ‹Ÿä»»åŠ¡çš„taskId
MOCK_TASK_ID=$(echo "$MOCK_RESPONSE" | grep -o '"redisStreamKey":"[^"]*"' | cut -d'"' -f4)
echo "æ¨¡æ‹Ÿä»»åŠ¡TaskId: $MOCK_TASK_ID"
echo -e "\n"

# =================================================================
# 7. é”™è¯¯æƒ…å†µæµ‹è¯•
# =================================================================
echo "7. é”™è¯¯æƒ…å†µæµ‹è¯•"

echo "7.1 æµ‹è¯•æ— æ•ˆçš„file_token"
curl -X POST "$BASE_URL/jobs/document-from-outline" \
  -H "Content-Type: application/json" \
  -d '{
    "taskPrompt": "æµ‹è¯•æ— æ•ˆtoken",
    "sessionId": "error_test_001",
    "outline": "invalid_file_token_123",
    "contextFiles": [],
    "isOnline": false
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

echo "7.2 æµ‹è¯•ç¼ºå°‘å¿…éœ€å‚æ•°"
curl -X POST "$BASE_URL/jobs/document-from-outline" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "error_test_002",
    "outline": "8b7e75b4150cde04bffba318da25068e"
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

# =================================================================
# 8. AIæ–‡æœ¬ç¼–è¾‘ç«¯ç‚¹æµ‹è¯•
# =================================================================
echo "8. AIæ–‡æœ¬ç¼–è¾‘ç«¯ç‚¹æµ‹è¯•"

echo "8.1 æ¶¦è‰²æ–‡æœ¬"
curl -X POST "$BASE_URL/actions/edit" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "polish",
    "text": "äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒä¼å›¾äº†è§£æ™ºèƒ½çš„å®è´¨ï¼Œå¹¶ç”Ÿäº§å‡ºä¸€ç§æ–°çš„èƒ½ä»¥äººç±»æ™ºèƒ½ç›¸ä¼¼çš„æ–¹å¼åšå‡ºååº”çš„æ™ºèƒ½æœºå™¨ã€‚",
    "polishStyle": "professional"
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

echo "8.2 æ‰©å†™æ–‡æœ¬"
curl -X POST "$BASE_URL/actions/edit" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "expand",
    "text": "äººå·¥æ™ºèƒ½æŠ€æœ¯æ­£åœ¨å¿«é€Ÿå‘å±•ã€‚"
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

echo "8.3 æ€»ç»“æ–‡æœ¬"
curl -X POST "$BASE_URL/actions/edit" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "summarize",
    "text": "äººå·¥æ™ºèƒ½ï¼ˆArtificial Intelligenceï¼ŒAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒä¼å›¾äº†è§£æ™ºèƒ½çš„å®è´¨ï¼Œå¹¶ç”Ÿäº§å‡ºä¸€ç§æ–°çš„èƒ½ä»¥äººç±»æ™ºèƒ½ç›¸ä¼¼çš„æ–¹å¼åšå‡ºååº”çš„æ™ºèƒ½æœºå™¨ã€‚è¯¥é¢†åŸŸçš„ç ”ç©¶åŒ…æ‹¬æœºå™¨äººã€è¯­è¨€è¯†åˆ«ã€å›¾åƒè¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†å’Œä¸“å®¶ç³»ç»Ÿç­‰ã€‚"
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

# =================================================================
# Redisæµç›‘å¬å‘½ä»¤
# =================================================================
echo "Redisæµç›‘å¬å‘½ä»¤:"
echo "ç›‘å¬å®æ—¶äº‹ä»¶: redis-cli XREAD COUNT 10 STREAMS $TASK_ID 0"
echo "æŸ¥çœ‹å†å²äº‹ä»¶: redis-cli XRANGE $TASK_ID - +"
echo "æŸ¥çœ‹æµé•¿åº¦: redis-cli XLEN $TASK_ID"
echo -e "\n"

echo "ğŸ‰ æµ‹è¯•å®Œæˆ!"
