# ä»»åŠ¡IDå®ç°æ€»ç»“

## ğŸ¯ **å®ç°ç›®æ ‡**

ä¸ºæ¯ä¸ªä»»åŠ¡ï¼ˆå¤§çº²ç”Ÿæˆã€æ–‡æ¡£ç”Ÿæˆï¼‰ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ä»»åŠ¡IDï¼ˆtask_idï¼‰ï¼Œä½œä¸ºRedisæµè¾“å‡ºçš„keyï¼Œç¡®ä¿ä»»åŠ¡è¿½è¸ªçš„å”¯ä¸€æ€§å’Œå¯é æ€§ã€‚

## âœ… **å®ç°å†…å®¹**

### 1. **ä»»åŠ¡IDç”Ÿæˆå™¨**

#### **æ–‡ä»¶ä½ç½®**
`service/src/doc_agent/core/task_id_generator.py`

#### **æ ¸å¿ƒåŠŸèƒ½**
- ç”Ÿæˆå…¨æ•°å­—çš„å”¯ä¸€ä»»åŠ¡ID
- æ ¼å¼ï¼š`æ—¶é—´æˆ³ + 6ä½éšæœºæ•°`
- ç¤ºä¾‹ï¼š`1754535042561613880`

#### **ç‰¹ç‚¹**
- **å”¯ä¸€æ€§**ï¼šä½¿ç”¨æ¯«ç§’çº§æ—¶é—´æˆ³ + UUIDéšæœºæ•°ç¡®ä¿å…¨å±€å”¯ä¸€
- **å…¨æ•°å­—**ï¼šç¬¦åˆRedisæµkeyçš„è¦æ±‚
- **å¯è¯»æ€§**ï¼šä¾¿äºè°ƒè¯•å’Œæ—¥å¿—è¿½è¸ª

### 2. **æ•°æ®æ¨¡å‹æ›´æ–°**

#### **ä¿®æ”¹çš„æ–‡ä»¶**
`service/src/doc_agent/schemas.py`

#### **æ›´æ–°çš„æ¨¡å‹**
- `OutlineGenerationResponse`ï¼šæ·»åŠ  `task_id` å­—æ®µ
- `TaskCreationResponse`ï¼šæ·»åŠ  `task_id` å­—æ®µ

#### **å“åº”æ ¼å¼**
```json
{
  "taskId": "1754535042561613880",
  "sessionId": "test_session_123",
  "redisStreamKey": "1754535042561613880",
  "status": "ACCEPTED",
  "message": "ä»»åŠ¡å·²æäº¤"
}
```

### 3. **APIç«¯ç‚¹æ›´æ–°**

#### **ä¿®æ”¹çš„æ–‡ä»¶**
`service/api/endpoints.py`

#### **æ›´æ–°çš„ç«¯ç‚¹**
1. **å¤§çº²ç”Ÿæˆæ¥å£** (`/jobs/outline`)
   - ç”Ÿæˆå”¯ä¸€çš„task_id
   - ä½¿ç”¨task_idä½œä¸ºRedisæµkey
   - åœ¨å“åº”ä¸­è¿”å›task_id

2. **æ–‡æ¡£ç”Ÿæˆæ¥å£** (`/jobs/document`)
   - ç”Ÿæˆå”¯ä¸€çš„task_id
   - ä½¿ç”¨task_idä½œä¸ºCeleryä»»åŠ¡çš„job_id
   - åœ¨å“åº”ä¸­è¿”å›task_id

3. **ä»outline JSONç”Ÿæˆæ–‡æ¡£æ¥å£** (`/jobs/document-from-outline`)
   - ç”Ÿæˆå”¯ä¸€çš„task_id
   - ä½¿ç”¨task_idä½œä¸ºCeleryä»»åŠ¡çš„job_id
   - åœ¨å“åº”ä¸­è¿”å›task_id

4. **æ¨¡æ‹ŸæœåŠ¡æ¥å£** (`/jobs/document-from-outline/mock`)
   - ç”Ÿæˆå”¯ä¸€çš„task_id
   - ä½¿ç”¨task_idä½œä¸ºRedisæµkey
   - åœ¨å“åº”ä¸­è¿”å›task_id

### 4. **Redisæµå‘å¸ƒå™¨é›†æˆ**

#### **å·¥ä½œåŸç†**
- ä½¿ç”¨task_idä½œä¸ºRedisæµçš„åç§°
- æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ç‹¬ç«‹çš„Redisæµ
- æ”¯æŒäº‹ä»¶å‘å¸ƒå’Œæµä¿¡æ¯æŸ¥è¯¢

#### **äº‹ä»¶ç±»å‹**
- `task_started`ï¼šä»»åŠ¡å¼€å§‹
- `task_progress`ï¼šä»»åŠ¡è¿›åº¦
- `task_completed`ï¼šä»»åŠ¡å®Œæˆ
- `task_failed`ï¼šä»»åŠ¡å¤±è´¥

## ğŸš€ **ä½¿ç”¨æµç¨‹**

### 1. **å¤§çº²ç”Ÿæˆæµç¨‹**
```
1. å®¢æˆ·ç«¯å‘é€å¤§çº²ç”Ÿæˆè¯·æ±‚
2. APIç”Ÿæˆå”¯ä¸€çš„task_id
3. ä½¿ç”¨task_idä½œä¸ºRedisæµkey
4. æäº¤Celeryä»»åŠ¡ï¼Œä½¿ç”¨task_idä½œä¸ºjob_id
5. è¿”å›task_idç»™å®¢æˆ·ç«¯
6. å®¢æˆ·ç«¯ä½¿ç”¨task_idç›‘å¬Redisæµ
```

### 2. **æ–‡æ¡£ç”Ÿæˆæµç¨‹**
```
1. å®¢æˆ·ç«¯å‘é€æ–‡æ¡£ç”Ÿæˆè¯·æ±‚
2. APIç”Ÿæˆå”¯ä¸€çš„task_id
3. ä½¿ç”¨task_idä½œä¸ºCeleryä»»åŠ¡çš„job_id
4. æäº¤Celeryä»»åŠ¡
5. è¿”å›task_idç»™å®¢æˆ·ç«¯
6. å®¢æˆ·ç«¯ä½¿ç”¨task_idç›‘å¬Redisæµ
```

## ğŸ“Š **æµ‹è¯•éªŒè¯**

### 1. **ä»»åŠ¡IDå”¯ä¸€æ€§æµ‹è¯•**
- âœ… ç”Ÿæˆ10ä¸ªä»»åŠ¡IDï¼Œå…¨éƒ¨å”¯ä¸€
- âœ… æ—¶é—´æˆ³ + éšæœºæ•°ç¡®ä¿å”¯ä¸€æ€§

### 2. **å“åº”æ¨¡å‹æµ‹è¯•**
- âœ… `OutlineGenerationResponse` æ­£å¸¸å·¥ä½œ
- âœ… `TaskCreationResponse` æ­£å¸¸å·¥ä½œ
- âœ… å­—æ®µæ˜ å°„å’Œåºåˆ—åŒ–æ­£å¸¸

### 3. **Redisæµå‘å¸ƒå™¨æµ‹è¯•**
- âœ… è¿æ¥RedisæœåŠ¡å™¨æˆåŠŸ
- âœ… å‘å¸ƒäº‹ä»¶åˆ°RedisæµæˆåŠŸ
- âœ… è·å–æµä¿¡æ¯æˆåŠŸ
- âœ… æµé•¿åº¦æŸ¥è¯¢æ­£å¸¸

## ğŸ”§ **æŠ€æœ¯ç»†èŠ‚**

### 1. **ä»»åŠ¡IDç”Ÿæˆç®—æ³•**
```python
timestamp = int(time.time() * 1000)  # æ¯«ç§’çº§æ—¶é—´æˆ³
random_part = uuid.uuid4().int % 1000000  # 6ä½éšæœºæ•°
task_id = f"{timestamp}{random_part:06d}"
```

### 2. **Redisæµkeyæ ¼å¼**
- ä½¿ç”¨task_idä½œä¸ºæµåç§°
- æ ¼å¼ï¼š`1754535042561613880`
- æ”¯æŒè‡ªåŠ¨ç”Ÿæˆçš„äº‹ä»¶ID

### 3. **äº‹ä»¶æ•°æ®ç»“æ„**
```json
{
  "eventType": "task_started",
  "taskType": "outline_generation",
  "status": "started",
  "timestamp": "2025-08-07T10:50:42.561680",
  "redis_id": "1754535042561613880-1"
}
```

## ğŸ¯ **ä¼˜åŠ¿**

### 1. **å”¯ä¸€æ€§ä¿è¯**
- æ¯«ç§’çº§æ—¶é—´æˆ³ç¡®ä¿æ—¶é—´ç»´åº¦å”¯ä¸€
- UUIDéšæœºæ•°ç¡®ä¿å¹¶å‘å®‰å…¨
- å…¨æ•°å­—æ ¼å¼é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜

### 2. **å¯è¿½è¸ªæ€§**
- æ¯ä¸ªä»»åŠ¡éƒ½æœ‰å”¯ä¸€çš„æ ‡è¯†ç¬¦
- æ”¯æŒå®Œæ•´çš„ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸè¿½è¸ª
- ä¾¿äºè°ƒè¯•å’Œç›‘æ§

### 3. **æ‰©å±•æ€§**
- æ”¯æŒå¤šç§ä»»åŠ¡ç±»å‹
- æ˜“äºæ·»åŠ æ–°çš„äº‹ä»¶ç±»å‹
- å…¼å®¹ç°æœ‰çš„APIæ¶æ„

## ğŸ“ **ä½¿ç”¨ç¤ºä¾‹**

### 1. **ç”Ÿæˆä»»åŠ¡ID**
```python
from src.doc_agent.core.task_id_generator import generate_task_id

task_id = generate_task_id()
print(f"ä»»åŠ¡ID: {task_id}")
# è¾“å‡º: ä»»åŠ¡ID: 1754535042561613880
```

### 2. **APIå“åº”ç¤ºä¾‹**
```json
{
  "taskId": "1754535042561613880",
  "sessionId": "12345",
  "redisStreamKey": "1754535042561613880",
  "status": "ACCEPTED",
  "message": "å¤§çº²ç”Ÿæˆä»»åŠ¡å·²æäº¤"
}
```

### 3. **Redisæµç›‘å¬**
```javascript
// å‰ç«¯ç›‘å¬Redisæµ
const taskId = "1754535042561613880";
const eventSource = new EventSource(`/api/stream/${taskId}`);
```

## âœ… **æ€»ç»“**

æˆåŠŸå®ç°äº†ä»»åŠ¡IDç”Ÿæˆå’Œç®¡ç†ç³»ç»Ÿï¼Œç¡®ä¿æ¯ä¸ªä»»åŠ¡éƒ½æœ‰å”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œå¹¶é€šè¿‡Redisæµè¿›è¡Œå®æ—¶è¿›åº¦æ¨é€ã€‚ç³»ç»Ÿå…·æœ‰è‰¯å¥½çš„å”¯ä¸€æ€§ã€å¯è¿½è¸ªæ€§å’Œæ‰©å±•æ€§ï¼Œä¸ºåç»­çš„åŠŸèƒ½å¼€å‘å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚
