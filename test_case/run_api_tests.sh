#!/bin/bash

# AIæ–‡æ¡£ç”Ÿæˆå™¨API - æµ‹è¯•è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: ./run_api_tests.sh

echo "ğŸš€ å¼€å§‹APIæµ‹è¯•..."
echo "=================================================="

# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
if curl -s http://localhost:8000/api/v1/health > /dev/null; then
    echo "âœ… æœåŠ¡æ­£åœ¨è¿è¡Œ"
else
    echo "âŒ æœåŠ¡æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨æœåŠ¡: ./start_dev_server.sh"
    exit 1
fi

echo -e "\n"

# ============================================================================
# 1. å¥åº·æ£€æŸ¥ç«¯ç‚¹
# ============================================================================
echo "ğŸ“‹ 1. æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹"
echo "--------------------------------------------------"
curl -X GET "http://localhost:8000/api/v1/health" \
  -H "Content-Type: application/json" \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

# ============================================================================
# 2. AIæ–‡æœ¬ç¼–è¾‘ç«¯ç‚¹æµ‹è¯•
# ============================================================================
echo "ğŸ“‹ 2. æµ‹è¯•AIæ–‡æœ¬ç¼–è¾‘ç«¯ç‚¹"
echo "--------------------------------------------------"

echo "2.1 æ¶¦è‰²æ–‡æœ¬æµ‹è¯•"
curl -X POST "http://localhost:8000/api/v1/actions/edit" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "polish",
    "text": "äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒä¼å›¾äº†è§£æ™ºèƒ½çš„å®è´¨ï¼Œå¹¶ç”Ÿäº§å‡ºä¸€ç§æ–°çš„èƒ½ä»¥äººç±»æ™ºèƒ½ç›¸ä¼¼çš„æ–¹å¼åšå‡ºååº”çš„æ™ºèƒ½æœºå™¨ã€‚",
    "polish_style": "professional"
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

echo "2.2 æ‰©å†™æ–‡æœ¬æµ‹è¯•"
curl -X POST "http://localhost:8000/api/v1/actions/edit" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "expand",
    "text": "äººå·¥æ™ºèƒ½æŠ€æœ¯æ­£åœ¨å¿«é€Ÿå‘å±•ã€‚"
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

echo "2.3 æ€»ç»“æ–‡æœ¬æµ‹è¯•"
curl -X POST "http://localhost:8000/api/v1/actions/edit" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "summarize",
    "text": "äººå·¥æ™ºèƒ½ï¼ˆArtificial Intelligenceï¼ŒAIï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒä¼å›¾äº†è§£æ™ºèƒ½çš„å®è´¨ï¼Œå¹¶ç”Ÿäº§å‡ºä¸€ç§æ–°çš„èƒ½ä»¥äººç±»æ™ºèƒ½ç›¸ä¼¼çš„æ–¹å¼åšå‡ºååº”çš„æ™ºèƒ½æœºå™¨ã€‚è¯¥é¢†åŸŸçš„ç ”ç©¶åŒ…æ‹¬æœºå™¨äººã€è¯­è¨€è¯†åˆ«ã€å›¾åƒè¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†å’Œä¸“å®¶ç³»ç»Ÿç­‰ã€‚"
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

# ============================================================================
# 3. å¤§çº²ç”Ÿæˆç«¯ç‚¹æµ‹è¯•
# ============================================================================
echo "ğŸ“‹ 3. æµ‹è¯•å¤§çº²ç”Ÿæˆç«¯ç‚¹"
echo "--------------------------------------------------"
OUTLINE_RESPONSE=$(curl -s -X POST "http://localhost:8000/api/v1/jobs/outline" \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "123456789",
    "taskPrompt": "è¯·ç”Ÿæˆä¸€ä»½å…³äºäººå·¥æ™ºèƒ½æŠ€æœ¯å‘å±•è¶‹åŠ¿çš„è¯¦ç»†å¤§çº²",
    "isOnline": true,
    "contextFiles": [],
    "attachmentType": 0,
    "attachmentFileToken": null,
    "isContentRefer": 0,
    "isStyleImitative": 0,
    "isWritingRequirement": 0
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n")

echo "$OUTLINE_RESPONSE"
echo -e "\n"

# æå–taskIdç”¨äºåç»­æµ‹è¯•
TASK_ID=$(echo "$OUTLINE_RESPONSE" | grep -o '"taskId":"[^"]*"' | cut -d'"' -f4)
if [ -n "$TASK_ID" ]; then
    echo "âœ… è·å–åˆ°taskId: $TASK_ID"
else
    echo "âš ï¸  æœªèƒ½è·å–åˆ°taskId"
fi
echo -e "\n"

# ============================================================================
# 4. æ–‡æ¡£ç”Ÿæˆç«¯ç‚¹æµ‹è¯• (ä»å¤§çº²å¯¹è±¡)
# ============================================================================
echo "ğŸ“‹ 4. æµ‹è¯•æ–‡æ¡£ç”Ÿæˆç«¯ç‚¹ (ä»å¤§çº²å¯¹è±¡)"
echo "--------------------------------------------------"
curl -X POST "http://localhost:8000/api/v1/jobs/document" \
  -H "Content-Type: application/json" \
  -d '{
    "jobId": "123456789",
    "outline": {
      "title": "äººå·¥æ™ºèƒ½æŠ€æœ¯å‘å±•è¶‹åŠ¿",
      "nodes": [
        {
          "title": "äººå·¥æ™ºèƒ½æ¦‚è¿°",
          "contentSummary": "ä»‹ç»äººå·¥æ™ºèƒ½çš„åŸºæœ¬æ¦‚å¿µå’Œå‘å±•å†ç¨‹",
          "children": []
        },
        {
          "title": "æ ¸å¿ƒæŠ€æœ¯å‘å±•",
          "contentSummary": "åˆ†ææœºå™¨å­¦ä¹ ã€æ·±åº¦å­¦ä¹ ç­‰æ ¸å¿ƒæŠ€æœ¯çš„æœ€æ–°è¿›å±•",
          "children": [
            {
              "title": "æœºå™¨å­¦ä¹ æŠ€æœ¯",
              "contentSummary": "ä¼ ç»Ÿæœºå™¨å­¦ä¹ ç®—æ³•çš„å‘å±•",
              "children": []
            },
            {
              "title": "æ·±åº¦å­¦ä¹ æŠ€æœ¯",
              "contentSummary": "ç¥ç»ç½‘ç»œå’Œæ·±åº¦å­¦ä¹ çš„æœ€æ–°çªç ´",
              "children": []
            }
          ]
        },
        {
          "title": "åº”ç”¨é¢†åŸŸæ‹“å±•",
          "contentSummary": "æ¢è®¨AIåœ¨å„ä¸ªè¡Œä¸šçš„åº”ç”¨ç°çŠ¶å’Œå‰æ™¯",
          "children": []
        }
      ]
    }
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

# ============================================================================
# 5. æ–‡æ¡£ç”Ÿæˆç«¯ç‚¹æµ‹è¯• (ä»å¤§çº²JSONå­—ç¬¦ä¸²)
# ============================================================================
echo "ğŸ“‹ 5. æµ‹è¯•æ–‡æ¡£ç”Ÿæˆç«¯ç‚¹ (ä»å¤§çº²JSONå­—ç¬¦ä¸²)"
echo "--------------------------------------------------"
curl -X POST "http://localhost:8000/api/v1/jobs/document-from-outline" \
  -H "Content-Type: application/json" \
  -d '{
    "jobId": "123456789",
    "outlineJson": "{\"title\":\"äººå·¥æ™ºèƒ½æŠ€æœ¯å‘å±•è¶‹åŠ¿\",\"nodes\":[{\"title\":\"äººå·¥æ™ºèƒ½æ¦‚è¿°\",\"contentSummary\":\"ä»‹ç»äººå·¥æ™ºèƒ½çš„åŸºæœ¬æ¦‚å¿µå’Œå‘å±•å†ç¨‹\",\"children\":[]},{\"title\":\"æ ¸å¿ƒæŠ€æœ¯å‘å±•\",\"contentSummary\":\"åˆ†ææœºå™¨å­¦ä¹ ã€æ·±åº¦å­¦ä¹ ç­‰æ ¸å¿ƒæŠ€æœ¯çš„æœ€æ–°è¿›å±•\",\"children\":[{\"title\":\"æœºå™¨å­¦ä¹ æŠ€æœ¯\",\"contentSummary\":\"ä¼ ç»Ÿæœºå™¨å­¦ä¹ ç®—æ³•çš„å‘å±•\",\"children\":[]},{\"title\":\"æ·±åº¦å­¦ä¹ æŠ€æœ¯\",\"contentSummary\":\"ç¥ç»ç½‘ç»œå’Œæ·±åº¦å­¦ä¹ çš„æœ€æ–°çªç ´\",\"children\":[]}]},{\"title\":\"åº”ç”¨é¢†åŸŸæ‹“å±•\",\"contentSummary\":\"æ¢è®¨AIåœ¨å„ä¸ªè¡Œä¸šçš„åº”ç”¨ç°çŠ¶å’Œå‰æ™¯\",\"children\":[]}]}",
    "sessionId": "123456789"
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

# ============================================================================
# 6. æ¨¡æ‹Ÿæ–‡æ¡£ç”Ÿæˆç«¯ç‚¹æµ‹è¯•
# ============================================================================
echo "ğŸ“‹ 6. æµ‹è¯•æ¨¡æ‹Ÿæ–‡æ¡£ç”Ÿæˆç«¯ç‚¹"
echo "--------------------------------------------------"
MOCK_RESPONSE=$(curl -s -X POST "http://localhost:8000/api/v1/jobs/document-from-outline/mock" \
  -H "Content-Type: application/json" \
  -d '{
    "job_id": "999888777",
    "outline_json": "{\"title\":\"äººå·¥æ™ºèƒ½æŠ€æœ¯å‘å±•è¶‹åŠ¿\",\"nodes\":[{\"title\":\"äººå·¥æ™ºèƒ½æ¦‚è¿°\",\"contentSummary\":\"ä»‹ç»äººå·¥æ™ºèƒ½çš„åŸºæœ¬æ¦‚å¿µå’Œå‘å±•å†ç¨‹\",\"children\":[]},{\"title\":\"æ ¸å¿ƒæŠ€æœ¯å‘å±•\",\"contentSummary\":\"åˆ†ææœºå™¨å­¦ä¹ ã€æ·±åº¦å­¦ä¹ ç­‰æ ¸å¿ƒæŠ€æœ¯çš„æœ€æ–°è¿›å±•\",\"children\":[{\"title\":\"æœºå™¨å­¦ä¹ æŠ€æœ¯\",\"contentSummary\":\"ä¼ ç»Ÿæœºå™¨å­¦ä¹ ç®—æ³•çš„å‘å±•\",\"children\":[]},{\"title\":\"æ·±åº¦å­¦ä¹ æŠ€æœ¯\",\"contentSummary\":\"ç¥ç»ç½‘ç»œå’Œæ·±åº¦å­¦ä¹ çš„æœ€æ–°çªç ´\",\"children\":[]}]},{\"title\":\"åº”ç”¨é¢†åŸŸæ‹“å±•\",\"contentSummary\":\"æ¢è®¨AIåœ¨å„ä¸ªè¡Œä¸šçš„åº”ç”¨ç°çŠ¶å’Œå‰æ™¯\",\"children\":[]}]}",
    "session_id": "999888777"
  }' \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n")

echo "$MOCK_RESPONSE"
echo -e "\n"

# æå–æ¨¡æ‹Ÿä»»åŠ¡çš„taskId
MOCK_TASK_ID=$(echo "$MOCK_RESPONSE" | grep -o '"taskId":"[^"]*"' | cut -d'"' -f4)
if [ -n "$MOCK_TASK_ID" ]; then
    echo "âœ… è·å–åˆ°æ¨¡æ‹Ÿä»»åŠ¡taskId: $MOCK_TASK_ID"
    echo "ğŸ’¡ æç¤º: å¯ä»¥ä½¿ç”¨ test_mock_endpoint.py æ¥ç›‘å¬Redisæµäº‹ä»¶"
else
    echo "âš ï¸  æœªèƒ½è·å–åˆ°æ¨¡æ‹Ÿä»»åŠ¡taskId"
fi
echo -e "\n"

# ============================================================================
# 7. æ ¹ç«¯ç‚¹æµ‹è¯•
# ============================================================================
echo "ğŸ“‹ 7. æµ‹è¯•æ ¹ç«¯ç‚¹"
echo "--------------------------------------------------"
curl -X GET "http://localhost:8000/" \
  -H "Content-Type: application/json" \
  -w "\nçŠ¶æ€ç : %{http_code}\nè€—æ—¶: %{time_total}s\n"
echo -e "\n"

# ============================================================================
# æµ‹è¯•æ€»ç»“
# ============================================================================
echo "ğŸ‰ APIæµ‹è¯•å®Œæˆ!"
echo "=================================================="
echo "ğŸ“Š æµ‹è¯•æ€»ç»“:"
echo "âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹"
echo "âœ… AIæ–‡æœ¬ç¼–è¾‘ç«¯ç‚¹ (æµå¼å“åº”)"
echo "âœ… å¤§çº²ç”Ÿæˆç«¯ç‚¹"
echo "âœ… æ–‡æ¡£ç”Ÿæˆç«¯ç‚¹ (ä»å¤§çº²å¯¹è±¡)"
echo "âœ… æ–‡æ¡£ç”Ÿæˆç«¯ç‚¹ (ä»å¤§çº²JSONå­—ç¬¦ä¸²)"
echo "âœ… æ¨¡æ‹Ÿæ–‡æ¡£ç”Ÿæˆç«¯ç‚¹"
echo "âœ… æ ¹ç«¯ç‚¹"
echo -e "\n"

echo "ğŸ’¡ ä½¿ç”¨æç¤º:"
echo "1. å¤§çº²ç”Ÿæˆä¼šè¿”å›taskIdï¼Œå¯ç”¨äºç›‘å¬Redisæµäº‹ä»¶"
echo "2. æ¨¡æ‹Ÿç«¯ç‚¹ä¼šç«‹å³å¼€å§‹ç”Ÿæˆæ¨¡æ‹Ÿå†…å®¹å¹¶å‘å¸ƒåˆ°Redisæµ"
echo "3. æµå¼ç¼–è¾‘ç«¯ç‚¹è¿”å›Server-Sent Eventsæ ¼å¼"
echo "4. æ‰€æœ‰å“åº”å­—æ®µéƒ½ä½¿ç”¨é©¼å³°å‘½åæ³• (camelCase)"
echo -e "\n"

echo "ğŸ”— ç›¸å…³æ–‡ä»¶:"
echo "- test_curl_commands.txt: è¯¦ç»†çš„curlå‘½ä»¤é›†åˆ"
echo "- test_mock_endpoint.py: Redisæµäº‹ä»¶ç›‘å¬æµ‹è¯•"
echo "- start_dev_server.sh: å¯åŠ¨å¼€å‘æœåŠ¡å™¨"
echo -e "\n"

echo "âœ¨ æµ‹è¯•è„šæœ¬æ‰§è¡Œå®Œæ¯•!"
