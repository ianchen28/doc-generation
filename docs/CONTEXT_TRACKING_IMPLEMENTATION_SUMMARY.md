# ä¸Šä¸‹æ–‡è¿½è¸ªæ—¥å¿—å®ç°æ€»ç»“

## ğŸ¯ **å®ç°ç›®æ ‡**

åœ¨æµ‹è¯•è„šæœ¬ä¸­å®ç°ä¸Šä¸‹æ–‡è¿½è¸ªæ—¥å¿—ï¼Œé€šè¿‡ `run_id` è¿½è¸ªæ•´ä¸ªå·¥ä½œæµçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæé«˜è°ƒè¯•å’Œç›‘æ§èƒ½åŠ›ã€‚

## âœ… **å®ç°å†…å®¹**

### 1. **å¯¼å…¥å¿…è¦çš„æ¨¡å—**

#### **æ–°å¢å¯¼å…¥**
```python
import uuid
```

#### **å®Œæ•´å¯¼å…¥åˆ—è¡¨**
```python
import asyncio
import json
import os
import pprint
import sys
import uuid  # ã€æ–°å¢ã€‘
from datetime import datetime

from loguru import logger
```

### 2. **ç”Ÿæˆå”¯ä¸€çš„ run_id**

#### **å®ç°ä»£ç **
```python
# --- 1.5. ã€æ–°å¢ã€‘ç”Ÿæˆ run_id å¹¶ç»‘å®šåˆ°æ—¥å¿—ä¸Šä¸‹æ–‡ ---
run_id = f"run-{uuid.uuid4().hex[:8]}"
logger.info(f"ğŸ“ All outputs for this run will be saved with timestamp: {run_timestamp}")
logger.info(f"ğŸ†” Generated run_id: {run_id}")
```

#### **ç‰¹ç‚¹**
- **å”¯ä¸€æ€§**: ä½¿ç”¨ UUID ç”Ÿæˆï¼Œç¡®ä¿å…¨å±€å”¯ä¸€
- **ç®€æ´æ€§**: åªå–å‰8ä½åå…­è¿›åˆ¶å­—ç¬¦ï¼Œä¾¿äºé˜…è¯»
- **å¯è¯»æ€§**: æ ¼å¼ä¸º `run-xxxxxxxx`ï¼Œæ˜“äºè¯†åˆ«

### 3. **ç»‘å®š run_id åˆ°æ—¥å¿—ä¸Šä¸‹æ–‡**

#### **å®ç°ä»£ç **
```python
# ç»‘å®š run_id åˆ°æ—¥å¿—ä¸Šä¸‹æ–‡
with logger.contextualize(run_id=run_id):
    logger.info("ğŸš€ Starting decoupled workflow test with context tracking")
    
    # æ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
    # ...
```

#### **ç‰¹ç‚¹**
- **ä¸Šä¸‹æ–‡ç®¡ç†**: ä½¿ç”¨ `with` è¯­å¥ç¡®ä¿ä¸Šä¸‹æ–‡æ­£ç¡®ç®¡ç†
- **è‡ªåŠ¨ç»‘å®š**: æ‰€æœ‰åœ¨ä¸Šä¸‹æ–‡ä¸­çš„æ—¥å¿—éƒ½ä¼šè‡ªåŠ¨åŒ…å« `run_id`
- **ä½œç”¨åŸŸæ¸…æ™°**: æ•´ä¸ªå·¥ä½œæµéƒ½åœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ

### 4. **å°† run_id ä¼ é€’ç»™ LangGraph çŠ¶æ€**

#### **ç¬¬ä¸€é˜¶æ®µçŠ¶æ€**
```python
stage_one_input_state = ResearchState(
    topic=topic,
    style_guide_content=STYLE_GUIDE_CONTENT,
    requirements_content=REQUIREMENTS_CONTENT,
    # ... å…¶ä»–å­—æ®µ ...
    initial_sources=[],
    document_outline={},
    chapters_to_process=[],
    current_chapter_index=0,
    completed_chapters=[],
    final_document="",
    messages=[],
    run_id=run_id,  # ã€æ–°å¢ã€‘æ·»åŠ  run_id åˆ°çŠ¶æ€
)
```

#### **ç¬¬äºŒé˜¶æ®µçŠ¶æ€**
```python
stage_two_input_state = ResearchState(
    topic=topic,
    document_outline=generated_outline,
    style_guide_content=STYLE_GUIDE_CONTENT,
    # ... å…¶ä»–å­—æ®µ ...
    initial_sources=[],
    requirements_content="",
    chapters_to_process=[],
    current_chapter_index=0,
    completed_chapters=[],
    final_document="",
    messages=[],
    run_id=run_id,  # ã€æ–°å¢ã€‘æ·»åŠ  run_id åˆ°çŠ¶æ€
)
```

## ğŸ—ï¸ **æŠ€æœ¯æ¶æ„**

### 1. **æ—¥å¿—æ ¼å¼ç»“æ„**
```
æ—¶é—´æˆ³ | æ—¥å¿—çº§åˆ« | æ¨¡å—:å‡½æ•°:è¡Œå· | run_id | æ¶ˆæ¯å†…å®¹
```

### 2. **ä¸Šä¸‹æ–‡ç®¡ç†æµç¨‹**
```
ç”Ÿæˆ run_id â†’ ç»‘å®šåˆ°æ—¥å¿—ä¸Šä¸‹æ–‡ â†’ ä¼ é€’ç»™çŠ¶æ€å¯¹è±¡ â†’ æ‰§è¡Œå·¥ä½œæµ â†’ æ‰€æœ‰æ—¥å¿—è‡ªåŠ¨åŒ…å« run_id
```

### 3. **çŠ¶æ€ä¼ é€’æœºåˆ¶**
```
main() â†’ run_stage_one_outline_generation() â†’ run_stage_two_document_generation()
    â†“           â†“                              â†“
run_id    â†’  ResearchState.run_id        â†’  ResearchState.run_id
```

## ğŸ“Š **æµ‹è¯•éªŒè¯**

### âœ… **æµ‹è¯•ç»“æœ**
```bash
2025-07-31 13:40:41.226 | INFO     | __main__:test_context_tracking:34 | run-b1a87a56 | ğŸš€ å¼€å§‹æ‰§è¡Œå¸¦è¿½è¸ªçš„æµ‹è¯•
2025-07-31 13:40:41.226 | WARNING  | __main__:test_context_tracking:36 | run-b1a87a56 | è¿™æ˜¯ä¸€æ¡è­¦å‘Šæ—¥å¿—
2025-07-31 13:40:41.227 | ERROR    | __main__:test_context_tracking:37 | run-b1a87a56 | è¿™æ˜¯ä¸€æ¡é”™è¯¯æ—¥å¿—
2025-07-31 13:40:41.227 | INFO     | __main__:test_context_tracking:41 | run-b1a87a56 | åµŒå¥—ä¸Šä¸‹æ–‡ä¸­çš„æ—¥å¿—
```

### ğŸ“‹ **éªŒè¯é¡¹ç›®**
- âœ… `run_id` ç”Ÿæˆæ­£å¸¸
- âœ… ä¸Šä¸‹æ–‡ç®¡ç†å™¨å·¥ä½œæ­£å¸¸
- âœ… åµŒå¥—ä¸Šä¸‹æ–‡æ­£å¸¸
- âœ… å¤šä¸ª `run_id` æ­£å¸¸
- âœ… æ—¥å¿—æ ¼å¼æ­£ç¡®æ˜¾ç¤º `run_id`

## ğŸš€ **åº”ç”¨åœºæ™¯**

### 1. **åˆ†å¸ƒå¼è¿½è¸ª**
- **è·¨æœåŠ¡è¿½è¸ª**: é€šè¿‡ `run_id` è¿½è¸ªè¯·æ±‚åœ¨ä¸åŒæœåŠ¡é—´çš„æµè½¬
- **å¼‚æ­¥ä»»åŠ¡è¿½è¸ª**: åœ¨ Celery ä»»åŠ¡ä¸­ä½¿ç”¨ç›¸åŒçš„ `run_id`
- **å·¥ä½œæµè¿½è¸ª**: è¿½è¸ª LangGraph å·¥ä½œæµçš„æ‰§è¡Œè¿‡ç¨‹

### 2. **è°ƒè¯•å’Œç›‘æ§**
- **é—®é¢˜å®šä½**: é€šè¿‡ `run_id` å¿«é€Ÿå®šä½ç‰¹å®šè¯·æ±‚çš„æ‰€æœ‰æ—¥å¿—
- **æ€§èƒ½åˆ†æ**: åˆ†æç‰¹å®šè¯·æ±‚çš„æ‰§è¡Œæ—¶é—´å’Œèµ„æºæ¶ˆè€—
- **é”™è¯¯è¿½è¸ª**: è¿½è¸ªé”™è¯¯åœ¨ç³»ç»Ÿä¸­çš„ä¼ æ’­è·¯å¾„

### 3. **æ—¥å¿—åˆ†æ**
- **æ—¥å¿—èšåˆ**: æŒ‰ `run_id` èšåˆç›¸å…³æ—¥å¿—
- **æ¨¡å¼è¯†åˆ«**: è¯†åˆ«ç‰¹å®šè¯·æ±‚çš„æ‰§è¡Œæ¨¡å¼
- **å¼‚å¸¸æ£€æµ‹**: æ£€æµ‹å¼‚å¸¸çš„æ‰§è¡Œæ¨¡å¼

## ğŸ“ **ä½¿ç”¨ç¤ºä¾‹**

### 1. **åŸºæœ¬ä½¿ç”¨**
```python
run_id = f"run-{uuid.uuid4().hex[:8]}"
with logger.contextualize(run_id=run_id):
    logger.info("å¼€å§‹æ‰§è¡Œä»»åŠ¡")
    # ... ä¸šåŠ¡é€»è¾‘
    logger.info("ä»»åŠ¡æ‰§è¡Œå®Œæˆ")
```

### 2. **åœ¨ Celery ä»»åŠ¡ä¸­ä½¿ç”¨**
```python
@celery_app.task
def my_task(job_id: str):
    run_id = f"run-{uuid.uuid4().hex[:8]}"
    with logger.contextualize(run_id=run_id):
        logger.info(f"å¼€å§‹æ‰§è¡Œä»»åŠ¡ {job_id}")
        # ... ä»»åŠ¡é€»è¾‘
        logger.info(f"ä»»åŠ¡ {job_id} æ‰§è¡Œå®Œæˆ")
```

### 3. **åœ¨ API ç«¯ç‚¹ä¸­ä½¿ç”¨**
```python
@app.post("/api/endpoint")
async def my_endpoint(request: Request):
    run_id = request.headers.get("X-Run-ID", f"run-{uuid.uuid4().hex[:8]}")
    with logger.contextualize(run_id=run_id):
        logger.info("API è¯·æ±‚å¼€å§‹")
        # ... å¤„ç†é€»è¾‘
        logger.info("API è¯·æ±‚å®Œæˆ")
```

## ğŸ¯ **æ¶æ„ä¼˜åŠ¿**

### 1. **å¯è§‚æµ‹æ€§**
- **å®Œæ•´è¿½è¸ª**: ä»è¯·æ±‚å¼€å§‹åˆ°ç»“æŸçš„å®Œæ•´è¿½è¸ª
- **å…³è”åˆ†æ**: é€šè¿‡ `run_id` å…³è”æ‰€æœ‰ç›¸å…³æ—¥å¿—
- **æ€§èƒ½ç›‘æ§**: ç›‘æ§ç‰¹å®šè¯·æ±‚çš„æ€§èƒ½æŒ‡æ ‡

### 2. **è°ƒè¯•å‹å¥½**
- **å¿«é€Ÿå®šä½**: é€šè¿‡ `run_id` å¿«é€Ÿå®šä½é—®é¢˜
- **ä¸Šä¸‹æ–‡å®Œæ•´**: ä¿ç•™å®Œæ•´çš„æ‰§è¡Œä¸Šä¸‹æ–‡
- **é”™è¯¯è¿½è¸ª**: è¿½è¸ªé”™è¯¯åœ¨ç³»ç»Ÿä¸­çš„ä¼ æ’­

### 3. **è¿ç»´æ”¯æŒ**
- **æ—¥å¿—èšåˆ**: æ”¯æŒæŒ‰ `run_id` èšåˆæ—¥å¿—
- **ç›‘æ§å‘Šè­¦**: åŸºäº `run_id` çš„ç›‘æ§å’Œå‘Šè­¦
- **é—®é¢˜è¯Šæ–­**: å¿«é€Ÿè¯Šæ–­ç”Ÿäº§ç¯å¢ƒé—®é¢˜

## ğŸ“ **æ€»ç»“**

ä¸Šä¸‹æ–‡è¿½è¸ªæ—¥å¿—å®ç°æˆåŠŸå®Œæˆï¼ä¸»è¦æ”¹è¿›åŒ…æ‹¬ï¼š

1. **å”¯ä¸€æ ‡è¯†** - ç”Ÿæˆå”¯ä¸€çš„ `run_id` ç”¨äºè¿½è¸ª
2. **ä¸Šä¸‹æ–‡ç®¡ç†** - ä½¿ç”¨ `logger.contextualize()` ç»‘å®šä¸Šä¸‹æ–‡
3. **çŠ¶æ€ä¼ é€’** - å°† `run_id` ä¼ é€’ç»™ LangGraph çŠ¶æ€å¯¹è±¡
4. **å®Œæ•´è¿½è¸ª** - æ•´ä¸ªå·¥ä½œæµéƒ½åœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
5. **æµ‹è¯•éªŒè¯** - å®Œæ•´çš„æµ‹è¯•è¦†ç›–å’ŒéªŒè¯

æ–°çš„ä¸Šä¸‹æ–‡è¿½è¸ªæœºåˆ¶ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„è°ƒè¯•å’Œç›‘æ§æä¾›äº†å¼ºå¤§çš„æ”¯æŒï¼ğŸ¯ 