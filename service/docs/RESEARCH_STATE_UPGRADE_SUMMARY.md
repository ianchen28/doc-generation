# ResearchState å‡çº§æ€»ç»“

## æ¦‚è¿°

æˆåŠŸå‡çº§äº† `service/src/doc_agent/graph/state.py` ä¸­çš„ `ResearchState`ï¼Œå°†å…¶ä»ç®€å•çš„å­—ç¬¦ä¸²å­—æ®µå‡çº§ä¸ºä½¿ç”¨æ–°çš„ `Source` æ¨¡å‹ï¼Œå®ç°äº†å®Œæ•´çš„ä¿¡æ¯æºè¿½è¸ªåŠŸèƒ½ã€‚

## ä¸»è¦å˜æ›´

### 1. å­—æ®µæ›¿æ¢

#### æ›¿æ¢å‰
```python
class ResearchState(TypedDict):
    # ç¬¬ä¸€å±‚: ä¸Šå±‚ç ”ç©¶çš„åˆå§‹ç ”ç©¶ç»“æœ
    initial_gathered_data: str  # åˆå§‹ç ”ç©¶ç»“æœ
    
    # ç« èŠ‚çº§ç ”ç©¶çŠ¶æ€
    gathered_data: str  # å½“å‰ç« èŠ‚æ”¶é›†çš„æ•°æ®
```

#### æ›¿æ¢å
```python
class ResearchState(TypedDict):
    # ç¬¬ä¸€å±‚: ä¸Šå±‚ç ”ç©¶çš„åˆå§‹ç ”ç©¶ç»“æœ
    initial_sources: list[Source]  # åˆå§‹ç ”ç©¶ç»“æœ
    
    # ç« èŠ‚çº§ç ”ç©¶çŠ¶æ€
    gathered_sources: list[Source]  # å½“å‰ç« èŠ‚æ”¶é›†çš„æ•°æ®
```

### 2. æ–°å¢å­—æ®µ

```python
class ResearchState(TypedDict):
    # ... å…¶ä»–å­—æ®µ ...
    
    # å…¨å±€å¼•ç”¨æºè¿½è¸ª - ç”¨äºæœ€ç»ˆå‚è€ƒæ–‡çŒ®
    cited_sources: dict  # å­˜å‚¨æ‰€æœ‰å”¯ä¸€æºï¼ŒæŒ‰IDç´¢å¼•
```

## å­—æ®µè¯¦è§£

### 1. `initial_sources: list[Source]`
- **ç”¨é€”**: å­˜å‚¨åˆå§‹ç ”ç©¶é˜¶æ®µæ”¶é›†çš„æ‰€æœ‰ä¿¡æ¯æº
- **ç‰¹ç‚¹**: åŒ…å«å®Œæ•´çš„ç»“æ„åŒ–æºä¿¡æ¯
- **ä¼˜åŠ¿**: æ¯”åŸæ¥çš„å­—ç¬¦ä¸²æ›´è¯¦ç»†ï¼Œæ”¯æŒå¼•ç”¨å’Œæº¯æº

### 2. `gathered_sources: list[Source]`
- **ç”¨é€”**: å­˜å‚¨å½“å‰ç« èŠ‚ç ”ç©¶è¿‡ç¨‹ä¸­æ”¶é›†çš„ä¿¡æ¯æº
- **ç‰¹ç‚¹**: ç« èŠ‚çº§åˆ«çš„æºè¿½è¸ª
- **ä¼˜åŠ¿**: æ”¯æŒç« èŠ‚çº§åˆ«çš„ä¿¡æ¯æºç®¡ç†

### 3. `cited_sources: dict`
- **ç”¨é€”**: å­˜å‚¨æ•´ä¸ªæ–‡æ¡£ä¸­æ‰€æœ‰å”¯ä¸€çš„ä¿¡æ¯æº
- **ç‰¹ç‚¹**: ä½¿ç”¨å­—å…¸ç»“æ„ï¼Œä»¥æºIDä¸ºé”®
- **ä¼˜åŠ¿**: 
  - è‡ªåŠ¨å»é‡ï¼ˆç›¸åŒIDçš„æºä¼šè¢«è¦†ç›–ï¼‰
  - ä¾¿äºç”Ÿæˆæœ€ç»ˆå‚è€ƒæ–‡çŒ®
  - æ”¯æŒå…¨å±€æºç®¡ç†

## åŠŸèƒ½ç‰¹æ€§

### 1. ç»“æ„åŒ–ä¿¡æ¯æºç®¡ç†
```python
# åˆ›å»ºä¿¡æ¯æº
source = Source(
    id=1,
    source_type="webpage",
    title="æ°´ç”µç«™æŠ€æœ¯å‘å±•æ¦‚è¿°",
    url="https://www.example.com/overview",
    content="æ°´ç”µç«™æŠ€æœ¯å‘å±•ç»å†äº†å¤šä¸ªé˜¶æ®µ..."
)

# æ·»åŠ åˆ°å¼•ç”¨æºå­—å…¸
cited_sources[source.id] = source
```

### 2. è‡ªåŠ¨å»é‡æœºåˆ¶
```python
# ç›¸åŒIDçš„æºä¼šè‡ªåŠ¨è¦†ç›–ï¼Œç¡®ä¿å”¯ä¸€æ€§
cited_sources[source.id] = source  # è‡ªåŠ¨å»é‡
```

### 3. å‚è€ƒæ–‡çŒ®ç”Ÿæˆ
```python
def get_bibliography(cited_sources: dict) -> str:
    """ç”Ÿæˆå‚è€ƒæ–‡çŒ®"""
    bibliography = "å‚è€ƒæ–‡çŒ®:\n"
    for source_id in sorted(cited_sources.keys()):
        source = cited_sources[source_id]
        if source.url:
            bibliography += f"[{source_id}] {source.title} - {source.url}\n"
        else:
            bibliography += f"[{source_id}] {source.title} ({source.source_type})\n"
    return bibliography
```

### 4. æºç±»å‹ç»Ÿè®¡
```python
# æŒ‰ç±»å‹ç»Ÿè®¡æº
source_types = {}
for source in research_sources:
    if source.source_type not in source_types:
        source_types[source.source_type] = 0
    source_types[source.source_type] += 1
```

## ä½¿ç”¨åœºæ™¯

### 1. åˆå§‹ç ”ç©¶é˜¶æ®µ
```python
# åˆå§‹ç ”ç©¶æ”¶é›†çš„æº
initial_sources = [
    Source(id=1, source_type="webpage", title="æ¦‚è¿°", ...),
    Source(id=2, source_type="document", title="è§„èŒƒ", ...)
]

research_state = {
    "initial_sources": initial_sources,
    "cited_sources": {1: initial_sources[0], 2: initial_sources[1]}
}
```

### 2. ç« èŠ‚ç ”ç©¶é˜¶æ®µ
```python
# ç« èŠ‚ç ”ç©¶æ”¶é›†çš„æº
gathered_sources = [
    Source(id=3, source_type="webpage", title="æŠ€æœ¯ç»†èŠ‚", ...),
    Source(id=4, source_type="es_result", title="æ¡ˆä¾‹åˆ†æ", ...)
]

research_state = {
    "gathered_sources": gathered_sources,
    "sources": gathered_sources,  # å½“å‰ç« èŠ‚çš„æº
    "cited_sources": {1: ..., 2: ..., 3: gathered_sources[0], 4: gathered_sources[1]}
}
```

### 3. æœ€ç»ˆæ–‡æ¡£ç”Ÿæˆ
```python
# ç”Ÿæˆæœ€ç»ˆå‚è€ƒæ–‡çŒ®
bibliography = get_bibliography(research_state["cited_sources"])
final_document = research_state["final_document"] + "\n\n" + bibliography
```

## æµ‹è¯•ç»“æœ

âœ… **åŠŸèƒ½æµ‹è¯•é€šè¿‡**
- ResearchState ç»“æ„å‡çº§
- æºç®¡ç†åŠŸèƒ½æ­£å¸¸
- å»é‡æœºåˆ¶æœ‰æ•ˆ
- å‚è€ƒæ–‡çŒ®ç”Ÿæˆæ­£ç¡®

âœ… **ä½¿ç”¨ç¤ºä¾‹éªŒè¯**
- åˆå§‹æºå’Œæ”¶é›†æºçš„æ­£ç¡®å¤„ç†
- å¼•ç”¨æºå­—å…¸çš„ç®¡ç†
- æºç±»å‹ç»Ÿè®¡åŠŸèƒ½
- å‚è€ƒæ–‡çŒ®æ ¼å¼ç”Ÿæˆ

## ä¼˜åŠ¿å¯¹æ¯”

### å‡çº§å‰
- âŒ åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²å½¢å¼çš„æ•°æ®
- âŒ æ— æ³•è¿½è¸ªå…·ä½“çš„ä¿¡æ¯æº
- âŒ ä¸æ”¯æŒå¼•ç”¨å’Œæº¯æº
- âŒ æ— æ³•ç”Ÿæˆå‚è€ƒæ–‡çŒ®

### å‡çº§å
- âœ… ç»“æ„åŒ–å­˜å‚¨ä¿¡æ¯æº
- âœ… å®Œæ•´çš„ä¿¡æ¯æºè¿½è¸ª
- âœ… æ”¯æŒå¼•ç”¨å’Œæº¯æº
- âœ… è‡ªåŠ¨ç”Ÿæˆå‚è€ƒæ–‡çŒ®
- âœ… æ”¯æŒæºç±»å‹ç»Ÿè®¡
- âœ… è‡ªåŠ¨å»é‡æœºåˆ¶

## åº”ç”¨ä»·å€¼

### 1. æ–‡æ¡£è´¨é‡æå‡
- æä¾›å®Œæ•´çš„ä¿¡æ¯æºè¿½è¸ª
- æ”¯æŒæ ‡å‡†å¼•ç”¨æ ¼å¼
- å¢å¼ºæ–‡æ¡£å¯ä¿¡åº¦

### 2. ç ”ç©¶è¿‡ç¨‹ä¼˜åŒ–
- è®°å½•ç ”ç©¶è¿‡ç¨‹ä¸­ä½¿ç”¨çš„æ‰€æœ‰ä¿¡æ¯æº
- æ”¯æŒå¢é‡ä¿¡æ¯æ”¶é›†
- ä¾¿äºå›æº¯å’ŒéªŒè¯

### 3. åˆè§„æ€§æ”¯æŒ
- æ»¡è¶³å­¦æœ¯å¼•ç”¨è¦æ±‚
- æ”¯æŒç‰ˆæƒå’Œæ¥æºå£°æ˜
- ä¾¿äºå®¡è®¡å’ŒéªŒè¯

## åç»­æ‰©å±•å»ºè®®

1. **å¼•ç”¨æ ¼å¼æ‰©å±•**
   - æ”¯æŒä¸åŒçš„å¼•ç”¨æ ¼å¼ï¼ˆAPAã€MLAç­‰ï¼‰
   - è‡ªåŠ¨ç”Ÿæˆå‚è€ƒæ–‡çŒ®åˆ—è¡¨

2. **æºè´¨é‡è¯„ä¼°**
   - æ·»åŠ æºå¯ä¿¡åº¦è¯„åˆ†
   - æ”¯æŒæºä¼˜å…ˆçº§æ’åº

3. **å†…å®¹å»é‡**
   - æ£€æµ‹é‡å¤æˆ–ç›¸ä¼¼å†…å®¹
   - åˆå¹¶ç›¸ä¼¼æº

4. **å…ƒæ•°æ®æ‰©å±•**
   - æ·»åŠ æ—¶é—´æˆ³ã€ä½œè€…ç­‰ä¿¡æ¯
   - æ”¯æŒæ›´ä¸°å¯Œçš„å…ƒæ•°æ®

## æ€»ç»“

ResearchState çš„å‡çº§ä¸ºæ–‡æ¡£ç”Ÿæˆç³»ç»Ÿæä¾›äº†ï¼š

- ğŸ” **å®Œæ•´çš„ä¿¡æ¯æºè¿½è¸ª** - ä»å­—ç¬¦ä¸²å‡çº§åˆ°ç»“æ„åŒ–æºç®¡ç†
- ğŸ“š **è§„èŒƒçš„å¼•ç”¨æ”¯æŒ** - æ”¯æŒæ ‡å‡†å¼•ç”¨æ ¼å¼å’Œå‚è€ƒæ–‡çŒ®ç”Ÿæˆ
- ğŸ›¡ï¸ **è´¨é‡ä¿è¯æœºåˆ¶** - æ”¯æŒä¿¡æ¯éªŒè¯å’Œæº¯æº
- ğŸ”§ **çµæ´»çš„æ‰©å±•æ€§** - æ”¯æŒå¤šç§æºç±»å‹å’Œæ ¼å¼
- ğŸ“Š **æ™ºèƒ½çš„æºç®¡ç†** - è‡ªåŠ¨å»é‡å’Œç±»å‹ç»Ÿè®¡

è¿™ä¸ªå‡çº§å¤§å¤§æå‡äº† AI æ–‡æ¡£ç”Ÿæˆç³»ç»Ÿçš„ä¿¡æ¯ç®¡ç†èƒ½åŠ›ï¼Œä¸ºç”Ÿæˆé«˜è´¨é‡ã€å¯è¿½æº¯çš„æ–‡æ¡£å¥ å®šäº†åšå®åŸºç¡€ã€‚ 