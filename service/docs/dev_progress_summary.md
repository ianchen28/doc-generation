# 阶段性开发总结（至2024-06）

本项目为基于大语言模型（LLM）和LangGraph控制的AI文档生成系统，以下为从零到当前阶段的主要开发历程与注意事项简要总结。

## 主要开发阶段

### 1. 项目结构与模块化

- 设计并实现了模块化项目结构，包含：
  - LLM客户端（多模型支持）
  - 工具集（Web搜索、ES检索、代码执行等）
  - 图逻辑（LangGraph）
  - API接口、任务队列、核心配置等
- 规范了 demo、tests、docs 等目录用途。

### 2. 配置系统

- 基于Pydantic实现YAML配置加载，支持环境变量替换和缓存。
- 保持`settings.xxx`接口不变，便于后续集成和扩展。
- 增加.env自动加载，统一环境变量管理。

### 3. LLM客户端与工具

- 实现了Qwen、Gemini、Reranker、Embedding等多种LLM客户端。
- 工厂函数统一管理各类工具和客户端。
- 支持真实API调用，参数适配多端点。
- 实现WebSearchTool、Elasticsearch检索工具，支持降级响应。

### 4. ES检索与内容处理

- ES工具支持自动发现知识库索引，优先文档数多的索引。
- 检索结果同时返回原始内容和切分内容，便于多场景使用。
- 针对ES数据异常（如向量NaN）做了健壮性处理。

### 5. 测试体系

- 所有测试统一放在`tests`目录，支持单文件和批量运行。
- 测试基类自动设置路径、加载环境变量，保证独立可运行。
- 支持`run_all_tests.py`批量运行，兼容IDE和命令行。
- 测试用例覆盖LLM客户端、工具工厂、ES/Web搜索等主要功能。

### 6. 资源清理与健壮性

- 全局注册表管理ES工具，确保测试后资源释放。
- 支持async with上下文管理器自动清理。
- 退出时清理函数做了异常兜底，彻底消除atexit相关警告。

## 注意事项与经验

- **路径与导入**：测试文件需动态添加service目录到sys.path，避免相对导入失败。
- **配置一致性**：所有配置均通过统一的settings接口访问，便于维护。
- **ES数据健壮性**：ES检索需注意数据异常（如向量缺失、NaN），查询时加exists过滤。
- **测试隔离**：每个测试文件可独立运行，批量运行时注意资源释放。
- **退出清理**：atexit注册和清理需加异常兜底，避免解释器关闭阶段报错。
- **内容展示**：ES检索结果建议同时展示原始内容和切分内容，便于调试和业务使用。

---

如需详细设计、接口说明或后续开发建议，请补充需求。
