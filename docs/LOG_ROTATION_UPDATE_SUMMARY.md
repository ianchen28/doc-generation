# 日志轮转功能更新总结

## 概述

为了解决 `logs/app.log` 文件不断增长的问题，我们对启动脚本进行了重大改进，集成了自动日志轮转功能。

## 问题描述

- 原有的启动脚本只是简单地将日志重定向到 `logs/app.log`
- 日志文件会无限增长，没有大小限制
- 虽然有手动轮转脚本，但需要手动执行或设置定时任务
- 缺乏自动化的日志管理机制

## 解决方案

### 1. 集成自动日志轮转功能

在两个主要启动脚本中集成了自动日志轮转功能：

- `quick_start.sh` - 单服务启动脚本
- `quick_start_multi.sh` - 多 Worker + 负载均衡器启动脚本

### 2. 核心功能特性

#### 日志轮转配置
```bash
LOG_SIZE="10M"           # 日志文件大小限制
LOG_ROTATE_COUNT=5       # 保留的备份文件数量
```

#### 自动监控机制
- 每30秒检查一次日志文件大小
- 当文件超过设定大小时自动执行轮转
- 轮转过程中记录操作日志

#### 轮转策略
1. 将现有备份文件向后移动（.1 → .2, .2 → .3, ...）
2. 将当前日志文件重命名为 .1
3. 创建新的空日志文件
4. 清理超出保留数量的旧备份文件

### 3. 修改的文件

#### quick_start.sh
- 添加了 `setup_log_rotation()` 函数
- 添加了 `start_service_with_log_rotation()` 函数
- 修改了 Celery 和 FastAPI 的启动方式
- 集成了实时日志大小监控

#### quick_start_multi.sh
- 添加了相同的日志轮转功能
- 为每个 Worker 和负载均衡器都启用了日志轮转
- 保持了多进程架构的兼容性

#### test_log_rotation.sh (新增)
- 创建了专门的测试脚本
- 可以验证日志轮转功能是否正常工作
- 支持多次轮转测试

## 使用方法

### 启动服务（自动启用日志轮转）
```bash
# 单服务启动
./quick_start.sh

# 多 Worker 启动
./quick_start_multi.sh 4 8082
```

### 测试日志轮转功能
```bash
./test_log_rotation.sh
```

### 查看日志和备份
```bash
# 查看当前日志
tail -f logs/app.log

# 查看所有备份文件
ls -lh logs/app.log*

# 查看备份文件内容
tail -f logs/app.log.1
```

## 配置选项

可以通过修改脚本中的以下变量来自定义日志轮转行为：

```bash
LOG_SIZE="10M"           # 文件大小限制 (支持 K, M, G)
LOG_ROTATE_COUNT=5       # 保留的备份文件数量
```

## 优势

1. **自动化管理**: 无需手动干预，系统自动管理日志文件大小
2. **实时监控**: 每30秒检查一次，及时响应文件大小变化
3. **历史保留**: 保留多个备份文件，便于问题排查
4. **磁盘空间保护**: 防止日志文件无限增长占用磁盘空间
5. **服务连续性**: 轮转过程中不影响服务正常运行
6. **操作记录**: 在日志中记录轮转操作，便于追踪

## 注意事项

1. 日志轮转功能会在后台运行，占用少量系统资源
2. 轮转操作会短暂中断日志写入，但时间很短（毫秒级）
3. 建议定期清理过旧的备份文件以节省磁盘空间
4. 如果需要更频繁的检查，可以调整 `sleep 30` 中的数值

## 兼容性

- 与现有的手动轮转脚本 `log_rotate.sh` 完全兼容
- 与定时任务设置脚本 `setup_log_rotation.sh` 兼容
- 不影响现有的日志查看和管理命令

## 测试验证

运行测试脚本验证功能：
```bash
./test_log_rotation.sh
```

测试脚本会：
1. 生成测试日志数据
2. 触发日志轮转
3. 验证轮转结果
4. 测试多次轮转功能

## 总结

通过这次更新，我们实现了：

✅ **自动日志轮转**: 无需手动干预的自动化日志管理  
✅ **大小限制**: 防止日志文件无限增长  
✅ **历史保留**: 保留多个备份文件便于问题排查  
✅ **实时监控**: 及时响应文件大小变化  
✅ **服务兼容**: 不影响现有服务的正常运行  
✅ **易于配置**: 简单的配置选项满足不同需求  

这个解决方案彻底解决了日志文件不断增长的问题，提供了完整的日志生命周期管理。
